#ifndef __UTILS__H
#define __UTILS__H

#include <iostream>
#include <vector>
#include <string>
#include <cmath>
#include <random>
#include <optional>

#include "HEaaN/HEaaN.hpp"

using namespace std;
using namespace HEaaN;

int comb(int n, int r);
vector<int> PerfectMapping(int input, int bitLength, int hammingWeight);
void printMessage(const HEaaN::Message &msg, bool is_complex = false,
                         size_t start_num = 10, size_t end_num = 10,
                         const int precision = 10);
void fillRandomReal(HEaaN::Message &msg);
double randNum();
void fillReal(HEaaN::Message &msg, double val);

class Params {
public:
    int server_bin_size;
    int effective_bitLength;
    int ell;
    int hw; 
    
    Params(int server_bin_size, int effective_bitLength, int hw);
};

void approxInverseNewtonX(const HomEvaluator &eval, 
                         const Ciphertext &ctxt, Ciphertext &ctxt_out,
                         Real initial, u64 num_iter);

void approxInverseNewtonU(const HomEvaluator &eval, 
                         const Bootstrapper &btp,
                         const Ciphertext &ctxt, Ciphertext &ctxt_out,
                         Real initial, u64 num_iter);

void approxSqrtWilkesX(const HomEvaluator &eval, 
                      const Ciphertext &ctxt, Ciphertext &ctxt_out,
                      const u64 num_iter);

void approxSqrtWilkesU(const HomEvaluator &eval, 
                      const Bootstrapper &btp,
                      const Ciphertext &ctxt, Ciphertext &ctxt_out,
                      const u64 num_iter);

namespace ChebyCoefTable{
    static const std::vector<Real> chebyshev_coef_deg_0{
      1.0};
    static const std::vector<Real> chebyshev_coef_deg_1{
      0.0, 1.0};
    static const std::vector<Real> chebyshev_coef_deg_2{
      0.5, -1.0, 0.5};
    static const std::vector<Real> chebyshev_coef_deg_3{
      -1.5, 2.75, -1.5, 0.25};
    static const std::vector<Real> chebyshev_coef_deg_4{
      5.875, -10.5, 6.0, -1.5, 
      0.125};
    static const std::vector<Real> chebyshev_coef_deg_5{
      -28.75, 50.875, -30.0, 9.0625, 
      -1.25, 0.0625};
    static const std::vector<Real> chebyshev_coef_deg_6{
      169.1875, -298.125, 179.96875, -60.9375, 
      10.8125, -0.9375, 0.03125};
    static const std::vector<Real> chebyshev_coef_deg_7{
      -1164.1875, 2047.921875, -1259.34375, 461.015625, 
      -95.8125, 11.046875, -0.65625, 0.015625};
    static const std::vector<Real> chebyshev_coef_deg_8{
      9173.2734375, -16129.3125, 10069.875, -3904.6875, 
      906.71875, -125.5625, 10.125, -0.4375, 
      0.0078125};
    static const std::vector<Real> chebyshev_coef_deg_9{
      -81450.84375, 143242.7109375, -90576.0, 36725.796875, 
      -9268.875, 1462.921875, -144.0, 8.56640625, 
      -0.28125, 0.00390625};
    static const std::vector<Real> chebyshev_coef_deg_10{
      804678.94921875, -1415923.2421875, 905168.25390625, -380454.609375, 
      102514.234375, -17872.734375, 2031.744140625, -149.23828125, 
      6.81640625, -0.17578125, 0.001953125};
    static const std::vector<Real> chebyshev_coef_deg_11{
      -8754751.11328125, 15416495.498046875, -9949871.46484375, 4308387.337890625, 
      -1224306.015625, 231000.3330078125, -29328.427734375, 2511.6630859375, 
      -142.87109375, 5.1669921875, -0.107421875, 0.0009765625};
    static const std::vector<Real> chebyshev_coef_deg_12{
      104010509.99511719, -183311137.32421875, 119311027.53125, -52979349.45703125, 
      15737060.007324219, -3167820.884765625, 439368.703125, -42363.943359375, 
      2829.9970703125, -128.326171875, 3.765625, -0.064453125, 
      0.00048828125};
    static const std::vector<Real> chebyshev_coef_deg_13{
      -1339781688.6035156, 2363399671.651367, -1549877573.765625, 703276237.2536621, 
      -216918305.25878906, 46102064.97241211, -6877516.8515625, 729466.6704101562, 
      -55206.099609375, 2956.79541015625, -109.3828125, 2.656494140625, 
      -0.0380859375, 0.000244140625};
    static const std::vector<Real> chebyshev_coef_deg_14{
      18598861787.671387, -32838916206.9541, 21681746413.40564, -10025989023.809814, 
      3194627119.477295, -711224755.6965332, 112823484.89172363, -12949428.190917969, 
      1083891.0278320312, -66096.08154296875, 2901.7025146484375, -89.244873046875, 
      1.823486328125, -0.022216796875, 0.0001220703125};
    static const std::vector<Real> chebyshev_coef_deg_15{
      -276803523130.87646, 489184561891.7316, -324976902403.0609, 152802033099.77887, 
      -50093386562.4353, 11610871881.935974, -1941615880.4278564, 238245682.6326294, 
      -21682236.525878906, 1468741.5067749023, -73716.49841308594, 2701.1912231445312, 
      -70.162353515625, 1.22283935546875, -0.0128173828125, 6.103515625e-05};
    static const std::vector<Real> chebyshev_coef_deg_16{
      4396645127909.0127, -7777060402708.381, 5195646833541.669, -2479565640979.431, 
      833607250927.3871, -200180579450.4712, 35048796988.70215, -4555334297.966309, 
      445090759.95788574, -32909099.11376953, 1841468.8251953125, -77411.19873046875, 
      2403.642333984375, -53.43017578125, 0.8037109375, -0.00732421875, 
      3.0517578125e-05};
    static const std::vector<Real> chebyshev_coef_deg_17{
      -74234852247898.4, 131427434988013.95, -88258662358510.62, 42687677297905.43, 
      -14677589125053.143, 3637217295165.5835, -663148708693.4531, 90632292641.79095, 
      -9415573857.86621, 750011700.211853, -45956756.359375, 2160515.4134521484, 
      -77190.591796875, 2057.1058349609375, -39.578125, 0.5190582275390625, 
      -0.004150390625, 1.52587890625e-05};
    static const std::vector<Real> chebyshev_coef_deg_18{
      1327706205708279.8, -2352630578223391.0, 1587454816237640.0, -777158639806174.1, 
      272681462422438.94, -69503062934688.23, 13137452841692.39, -1877031116186.106, 
      205755907754.727, -17480964210.714294, 1157350965.9220276, -59745735.50427246, 
      2393526.3201904297, -73585.88415527344, 1701.6405715942383, -28.615127563476562, 
      0.3300933837890625, -0.0023345947265625, 7.62939453125e-06};
    static const std::vector<Real> chebyshev_coef_deg_19{
      -2.507502699186073e+16, 4.4468784021848136e+16, -3.01390813012923e+16, 1.4918923655841174e+16, 
      -5331597174974332.0, 1393964590456454.0, -272164198175900.22, 40458164466073.46, 
      -4650862379783.496, 418113985153.1818, -29602672359.70578, 1655295485.1980133, 
      -72993134.4576416, 2522159.895175934, -67436.77993011475, 1366.0576286315918, 
      -20.250411987304688, 0.20707321166992188, -0.00130462646484375, 3.814697265625e-06};
    static const std::vector<Real> chebyshev_coef_deg_20{
      4.986599048562779e+17, -8.850514640576214e+17, 6.023363985633984e+17, -3.0119488869911565e+17, 
      1.0945679044766112e+17, -2.9287207905247736e+16, 5888331142803368.0, -907112655133237.8, 
      108804524441499.75, -10284398243982.059, 772335415153.5997, -46288446965.84396, 
      2215778377.241785, -84451323.6271286, 2543061.795074463, -59683.61011505127, 
      1067.89017868042, -14.060249328613281, 0.128326416015625, -0.00072479248046875, 
      1.9073486328125e-06};
    static const std::vector<Real> chebyshev_coef_deg_21{
      -1.041572382915437e+19, 1.8500857385290408e+19, -1.2639851147646337e+19, 6.379794368487842e+18, 
      -2.354376857255404e+18, 6.434167189001868e+17, -1.328637831362578e+17, 2.1140820936287184e+16, 
      -2634789015518605.5, 260476394807967.78, -20612051648545.94, 1313044536082.2998, 
      -67502016689.57124, 2798187192.061002, -93116739.52011108, 2465737.044927597, 
      -51206.63875579834, 815.2142391204834, -9.597015380859375, 0.0786600112915039, 
      -0.000400543212890625, 9.5367431640625e-07};
    static const std::vector<Real> chebyshev_coef_deg_22{
      2.27980629104887e+20, -4.052536544940761e+20, 2.7787719997746224e+20, -1.4147279574069556e+20, 
      5.29535195460575e+19, -1.4755371417099758e+19, 3.122418215779652e+18, -5.117065257379191e+17, 
      6.603121799143827e+16, -6797704824550899.0, 563747804291489.8, -37913712090346.06, 
      2075463712118.177, -92559497747.82675, 3355777994.4752975, -98364451.02291298, 
      2308615.543455124, -42727.61690711975, 609.1837725639343, -6.450568199157715, 
      0.04774188995361328, -0.00022029876708984375, 4.76837158203125e-07};
    static const std::vector<Real> chebyshev_coef_deg_23{
      -5.218200667554551e+21, 9.282499627963292e+21, -6.386661624621554e+21, 3.277816866057062e+21, 
      -1.2430915135921628e+21, 3.5265614005711326e+20, -7.632673971857118e+19, 1.2851768283119768e+19, 
      -1.711938911092877e+18, 1.828469890379846e+17, -1.5820260962733398e+16, 1117013299989417.1, 
      -64663337460646.83, 3075718695508.514, -120156046977.88136, 3843061227.5134616, 
      -99993131.27592278, 2094619.9355704784, -34769.07673406601, 446.5282576084137, 
      -4.2757158279418945, 0.028717756271362305, -0.00012063980102539062, 2.384185791015625e-07};
    static const std::vector<Real> chebyshev_coef_deg_24{
      1.2465986516773633e+23, -2.2190902292302107e+23, 1.531733756133059e+23, -7.920466448841929e+22, 
      3.040634131567683e+22, -8.770800347968971e+21, 1.9382689676972531e+21, -3.346100098265866e+20, 
      4.589190259121505e+19, -5.069360333901452e+18, 4.558480033118552e+17, -3.3633768049853624e+16, 
      2047301270937340.0, -103133276750508.17, 4303369958859.2847, -148518428287.3882, 
      4222419943.0707397, -98190208.69444942, 1847221.9967975616, -27656.82614994049, 
      321.6199517250061, -2.798426628112793, 0.017133712768554688, -6.580352783203125e-05, 
      1.1920928955078125e-07};
    static const std::vector<Real> chebyshev_coef_deg_25{
      -3.102791275487182e+24, 5.527063103126895e+24, -3.826717858425062e+24, 1.9927018061865548e+24, 
      -7.737399239944381e+23, 2.266715134929424e+23, -5.107116040363187e+22, 9.022720670982313e+21, 
      -1.271245347269405e+21, 1.448385233108983e+20, -1.3491849130460178e+19, 1.0361580854878831e+18, 
      -6.600368116579823e+16, 3501000962460295.5, -154921776602020.66, 5718238468298.496, 
      -175646387881.73914, 4468698591.200555, -93442260.68344116, 1587535.635973215, 
      -21548.69112968445, 227.98078179359436, -1.810455322265625, 0.01014620065689087, 
      -3.5762786865234375e-05, 5.960464477539063e-08};
    static const std::vector<Real> chebyshev_coef_deg_26{
      8.0333313438743e+25, -1.4319272778287205e+26, 9.942782891528328e+25, -5.21177740458736e+25, 
      2.0453184759700697e+25, -6.079193379522592e+24, 1.3946261271727588e+24, -2.517392196500085e+23, 
      3.636491327888174e+22, -4.2633316809723903e+21, 4.102335689596976e+20, -3.268287854301007e+19, 
      2.169921572370127e+18, -1.206043255327075e+17, 5626404015514815.0, -220504673202413.6, 
      7252513280488.327, -199587379851.22516, 4571199580.504293, -86420295.5866158, 
      1332599.0866196156, -16474.770337343216, 159.25684705376625, -1.1589005589485168, 
      0.005967199802398682, -1.9371509552001953e-05, 2.9802322387695312e-08};
    static const std::vector<Real> chebyshev_coef_deg_27{
      -2.1602625132987543e+27, 3.8530581502510585e+27, -2.6827788027117384e+27, 1.415002632030206e+27, 
      -5.6088128746491635e+26, 1.689829333110242e+26, -3.942574560607803e+25, 7.260715231126041e+24, 
      -1.0734890209164157e+24, 1.2923419712920285e+23, -1.2814080072709837e+22, 1.0559565873842954e+21, 
      -7.2819702315894686e+19, 4.223486452043216e+18, -2.0669891950634013e+17, 8549949767660405.0, 
      -298917475583829.0, 8817814116166.268, -218688089166.51746, 4533193775.047466, 
      -77865961.43058658, 1094723.2005042583, -12378.642642349005, 109.76282165944576, 
      -0.7346071600914001, 0.0034872740507125854, -1.0460615158081055e-05, 1.4901161193847656e-08};
    static const std::vector<Real> chebyshev_coef_deg_28{
      6.025361693419189e+28, -1.0753422197143319e+29, 7.506905806435756e+28, -3.982690110990388e+28, 
      1.5935787544223354e+28, -4.862692715933149e+27, 1.1526169556351817e+27, -2.162889285539003e+26, 
      3.2679178278870844e+25, -4.0324748729830394e+24, 4.1112523882145915e+23, -3.4954277746888845e+22, 
      2.4962219994473263e+21, -1.505473348228673e+20, 7.696889027576621e+18, -3.343475622177928e+17, 
      1.2350155631651668e+16, -387649062972986.94, 10315752062466.63, -231779209490.25565, 
      4369525207.749823, -68496696.45022944, 881639.833006382, -9153.284809559584, 
      74.71754778921604, -0.4614652097225189, 0.002026081085205078, -5.632638931274414e-06, 
      7.450580596923828e-09};
    static const std::vector<Real> chebyshev_coef_deg_29{
      -1.7408683851430898e+30, 3.1087463611665003e+30, -2.1756141873426806e+30, 1.1606556538815991e+30, 
      -4.685468481511724e+29, 1.4469959829605746e+29, -3.481276558002862e+28, 6.648738066466235e+27, 
      -1.0251776935218252e+27, 1.2945444820237128e+26, -1.3545221262365818e+25, 1.185530507323341e+24, 
      -8.7446628525381e+22, 5.467284819277739e+21, -2.90953733964688e+20, 1.3216351333702339e+19, 
      -5.131719633266295e+17, 1.7034409455100704e+16, -482781478840304.3, 11649878659564.35, 
      -238270558910.34805, 4103110924.397839, -58938840.19169819, 697149.249944754, 
      -6668.964475482702, 50.28081280738115, -0.2874656915664673, 0.0011707581579685211, 
      -3.0249357223510742e-06, 3.725290298461914e-09};
    static const std::vector<Real> chebyshev_coef_deg_30{
      5.203955634973285e+31, -9.298231995264293e+31, 6.522751244046179e+31, -3.4981094480313304e+31, 
      1.4240536222472829e+31, -4.4479681574512674e+30, 1.0852443700020918e+30, -2.1073237556429605e+29, 
      3.3119249369467243e+28, -4.2735404552608624e+27, 4.581314059634561e+26, -4.119671865782249e+25, 
      3.1314511233073575e+24, -2.0242005088872723e+23, 1.1177908870281672e+22, -5.2900764164137504e+20, 
      2.1498679808050967e+19, -7.508252466006552e+17, 2.2523692553248956e+16, -579356355826973.4, 
      12736837093644.467, -238154965682.8071, 3761130402.383139, -49690082.8264847, 
      541999.735167779, -4792.769542001188, 33.47749683819711, -0.17768634483218193, 
      0.0006731040775775909, -1.6205012798309326e-06, 1.862645149230957e-09};
    static const std::vector<Real> chebyshev_coef_deg_31{
      -1.607677850468307e+33, 2.874122911149252e+33, -2.0208070804303316e+33, 1.0891668587408662e+33, 
      -4.469306179930672e+32, 1.4110193501977543e+32, -3.488668136657054e+31, 6.881153076614661e+30, 
      -1.1010804390937956e+30, 1.4499490404554125e+29, -1.5901310765863026e+28, 1.4665329882780565e+27, 
      -1.1464310305357637e+26, 7.643916042750639e+24, -4.3681179537363446e+23, 2.1469933024286115e+22, 
      -9.098396276855173e+20, 3.328535914832177e+19, -1.05141307807571e+18, 2.86489053699805e+16, 
      -671902368205662.2, 13514948082507.64, -231936239954.31104, 3371538685.8536954, 
      -41107429.853046715, 414799.69259234425, -3400.7985193189234, 22.069675316102803, 
      -0.10903710499405861, 0.00038516800850629807, -8.66129994392395e-07, 9.313225746154785e-10};
    static const std::vector<Real> chebyshev_coef_deg_32{
      5.127507482009214e+34, -9.171589163631029e+34, 6.462666437828533e+34, -3.4998041470178553e+34, 
      1.4469983554665404e+34, -4.615068635292857e+33, 1.1554786664118817e+33, -2.313096262778866e+32, 
      3.7646567602237757e+31, -5.053332900341607e+30, 5.661713522586634e+29, -5.347049957107804e+28, 
      4.2910246468212704e+27, -2.945013547497447e+26, 1.737385864447013e+25, -8.844287412535294e+23, 
      3.895663764996825e+22, -1.4872916539797712e+21, 4.925080944719287e+19, -1.414158556691353e+18, 
      3.5160183573407024e+16, -755030542780544.5, 13949183249180.389, -220506372953.5466, 
      2960307068.2175922, -33414205.796145692, 312835.6352327168, -2384.6137130111456, 
      14.415180496871471, -0.06645919382572174, 0.00021943449974060059, -4.6193599700927734e-07, 
      4.656612873077393e-10};

    
    static const std::vector<std::vector<HEaaN::Real>> ChebyCoefDeg{
      chebyshev_coef_deg_0, chebyshev_coef_deg_1, chebyshev_coef_deg_2, chebyshev_coef_deg_3,
      chebyshev_coef_deg_4, chebyshev_coef_deg_5, chebyshev_coef_deg_6, chebyshev_coef_deg_7,
      chebyshev_coef_deg_8, chebyshev_coef_deg_9, chebyshev_coef_deg_10, chebyshev_coef_deg_11,
      chebyshev_coef_deg_12, chebyshev_coef_deg_13, chebyshev_coef_deg_14, chebyshev_coef_deg_15,
      chebyshev_coef_deg_16, chebyshev_coef_deg_17, chebyshev_coef_deg_18, chebyshev_coef_deg_19,
      chebyshev_coef_deg_20, chebyshev_coef_deg_21, chebyshev_coef_deg_22, chebyshev_coef_deg_23,
      chebyshev_coef_deg_24, chebyshev_coef_deg_25, chebyshev_coef_deg_26, chebyshev_coef_deg_27,
      chebyshev_coef_deg_28, chebyshev_coef_deg_29, chebyshev_coef_deg_30, chebyshev_coef_deg_31,
      chebyshev_coef_deg_32
    };

} // namespace ChebyCoefTable

#endif
